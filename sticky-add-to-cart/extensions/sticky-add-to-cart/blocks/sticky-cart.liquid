{% comment %}
  Sticky Add to Cart Bar - Full Featured
  Shopify Theme App Extension (App Embed Block)
  Uses IntersectionObserver for Smart Scroll Detection
{% endcomment %}

{% if product and product.available %}
  <div 
    id="sticky-cart-bar"
    class="sticky-atc" 
    data-sticky-atc
    data-position="{{ block.settings.position }}"
    data-show-desktop="{{ block.settings.show_desktop }}"
    data-show-mobile="{{ block.settings.show_mobile }}"
  >
    <div class="sticky-atc__wrapper">
      <div class="sticky-atc__content">
        {% if product.featured_image %}
          <img 
            src="{{ product.featured_image | image_url: width: 120 }}" 
            alt="{{ product.title | escape }}"
            class="sticky-atc__img"
            loading="lazy"
            width="60"
            height="60"
          >
        {% endif %}
        
        <div class="sticky-atc__info">
          <h3 class="sticky-atc__title">{{ product.title }}</h3>
          <p class="sticky-atc__price">
            {{ product.selected_or_first_available_variant.price | money }}
          </p>
        </div>
      </div>

      <button 
        type="button"
        id="sticky-add-to-cart"
        class="sticky-atc__btn"
        aria-label="Add {{ product.title }} to cart"
      >
        <span class="sticky-atc__btn-text">Add to Cart</span>
      </button>
    </div>
  </div>

  <style>
    /* ===== Sticky Add to Cart Styles ===== */
    .sticky-atc {
      position: fixed;
      left: 0;
      right: 0;
      width: 100%;
      background-color: {{ block.settings.background_color }};
      color: {{ block.settings.text_color }};
      box-shadow: 0 -3px 16px rgba(0, 0, 0, 0.12);
      transform: translateY(100%);
      opacity: 0;
      visibility: hidden;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                  opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                  visibility 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999999;
      padding: 16px 20px;
    }

    /* Position Variants */
    .sticky-atc[data-position="bottom"] {
      bottom: 0;
      top: auto;
      transform: translateY(100%);
    }

    .sticky-atc[data-position="top"] {
      top: 0;
      bottom: auto;
      transform: translateY(-100%);
      box-shadow: 0 3px 16px rgba(0, 0, 0, 0.12);
    }

    /* Visible State */
    .sticky-atc.is-visible {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      .sticky-atc {
        transform: none;
        transition: opacity 0.2s ease, visibility 0.2s ease;
      }

      .sticky-atc:not(.is-visible) {
        opacity: 0;
        visibility: hidden;
      }

      .sticky-atc.is-visible {
        opacity: 1;
        visibility: visible;
      }
    }

    /* Container */
    .sticky-atc__wrapper {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .sticky-atc__content {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
      min-width: 0;
    }

    /* Product Image */
    .sticky-atc__img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    /* Product Info */
    .sticky-atc__info {
      flex: 1;
      min-width: 0;
    }

    .sticky-atc__title {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.3;
      color: inherit;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sticky-atc__price {
      margin: 6px 0 0;
      font-size: 18px;
      font-weight: 700;
      color: inherit;
    }

    /* Add to Cart Button */
    .sticky-atc__btn {
      background-color: {{ block.settings.btn_bg_color }};
      color: {{ block.settings.btn_text_color }};
      border: none;
      padding: 16px 40px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s ease, opacity 0.2s ease;
      white-space: nowrap;
      min-width: 160px;
      text-align: center;
      line-height: 1;
    }

    .sticky-atc__btn:hover:not(:disabled) {
      transform: translateY(-2px);
      opacity: 0.9;
    }

    .sticky-atc__btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .sticky-atc__btn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    .sticky-atc__btn:focus-visible {
      outline: 3px solid {{ block.settings.btn_bg_color }};
      outline-offset: 4px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sticky-atc {
        padding: 12px 16px;
      }

      .sticky-atc__wrapper {
        gap: 14px;
      }

      .sticky-atc__content {
        gap: 12px;
      }

      .sticky-atc__img {
        width: 50px;
        height: 50px;
      }

      .sticky-atc__title {
        font-size: 14px;
      }

      .sticky-atc__price {
        font-size: 16px;
        margin-top: 4px;
      }

      .sticky-atc__btn {
        padding: 13px 28px;
        font-size: 14px;
        min-width: 140px;
      }
    }

    /* Device Visibility Controls */
    @media (min-width: 769px) {
      .sticky-atc[data-show-desktop="false"] {
        display: none !important;
      }
    }

    @media (max-width: 768px) {
      .sticky-atc[data-show-mobile="false"] {
        display: none !important;
      }
    }
  </style>

  <script>
    (function() {
      'use strict';

      // Prevent multiple initializations
      if (window.stickyATCInitialized) return;
      window.stickyATCInitialized = true;

      const stickyBar = document.querySelector('[data-sticky-atc]');
      if (!stickyBar) return;

      const stickyBtn = document.getElementById('sticky-add-to-cart');
      const btnText = stickyBtn ? stickyBtn.querySelector('.sticky-atc__btn-text') : null;

      // ===== SMART BUTTON DETECTION =====
      function findMainButton() {
        const selectors = [
          'form[action*="/cart/add"] button[type="submit"]',
          '.product-form__submit',
          '[name="add"]',
          'button[class*="add-to-cart"]',
          '.product-form button[type="submit"]',
          '[data-add-to-cart]'
        ];

        for (const selector of selectors) {
          const button = document.querySelector(selector);
          if (button && button.offsetParent !== null) {
            return button;
          }
        }
        return null;
      }

      const mainButton = findMainButton();

      // ===== VISIBILITY LOGIC =====
      const productForm = document.querySelector('form[action*="/cart/add"]') ||
                         document.querySelector('.product-form') ||
                         document.querySelector('[data-product-form]');

      // If no main button found, show sticky bar immediately as fallback
      if (!mainButton && !productForm) {
        console.log('Sticky ATC: No main button found, showing bar as fallback');
        stickyBar.classList.add('is-visible');
      } else if (productForm && 'IntersectionObserver' in window) {
        // Primary: Use IntersectionObserver
        const observer = new IntersectionObserver(
          function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                // Form is visible - hide sticky bar
                stickyBar.classList.remove('is-visible');
              } else {
                // Form is NOT visible - show sticky bar
                stickyBar.classList.add('is-visible');
              }
            });
          },
          {
            threshold: 0,
            rootMargin: '0px'
          }
        );

        observer.observe(productForm);

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
          observer.disconnect();
        });

      } else {
        // Fallback: Scroll-based visibility
        let scrollTimeout;
        window.addEventListener('scroll', function() {
          clearTimeout(scrollTimeout);
          
          scrollTimeout = setTimeout(function() {
            if (window.scrollY > 400) {
              stickyBar.classList.add('is-visible');
            } else {
              stickyBar.classList.remove('is-visible');
            }
          }, 15);
        });
      }

      // ===== PROXY CLICK METHOD =====
      if (stickyBtn) {
        stickyBtn.addEventListener('click', function(e) {
          e.preventDefault();

          if (stickyBtn.disabled) return;

          // Re-check button availability
          const currentMainButton = findMainButton();

          if (!currentMainButton) {
            // Try to submit the form directly
            const form = document.querySelector('form[action*="/cart/add"]');
            if (form) {
              form.submit();
            } else {
              console.error('Sticky ATC: No add to cart form found.');
            }
            return;
          }

          // Visual feedback
          const originalText = btnText ? btnText.textContent : 'Add to Cart';
          if (btnText) btnText.textContent = 'Adding...';
          stickyBtn.disabled = true;

          // Trigger the main button click
          currentMainButton.click();

          // Reset after delay
          setTimeout(function() {
            if (btnText) btnText.textContent = 'Added!';
            
            setTimeout(function() {
              if (btnText) btnText.textContent = originalText;
              stickyBtn.disabled = false;
            }, 1500);
          }, 400);
        });
      }

    })();
  </script>
{% endif %}

{% schema %}
{
  "name": "Minato Sticky Add To Cart",
  "target": "body",
  "templates": ["product"],
  "settings": [
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "btn_bg_color",
      "label": "Button Background",
      "default": "#45C0B6"
    },
    {
      "type": "color",
      "id": "btn_text_color",
      "label": "Button Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Position",
      "options": [
        {
          "value": "bottom",
          "label": "Bottom"
        },
        {
          "value": "top",
          "label": "Top"
        }
      ],
      "default": "bottom"
    },
    {
      "type": "header",
      "content": "Device Visibility"
    },
    {
      "type": "checkbox",
      "id": "show_desktop",
      "label": "Show on Desktop",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_mobile",
      "label": "Show on Mobile",
      "default": true
    }
  ]
}
{% endschema %}
